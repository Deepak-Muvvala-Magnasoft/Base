<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitor Registration</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
/* ===== Global & Reset ===== */
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; padding: 0; }
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f6f9;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  color: #111827;
}

/* ---------- Navbar (fixed) ---------- */
/* main bar */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
  background: linear-gradient(90deg, #007bff, #0056b3);
  /* subtle bottom border so navbar visually separates from page */
  box-shadow: 0 4px 10px rgba(14,30,37,0.06);
  padding: 8px 0;
  -webkit-font-smoothing: antialiased;
}

/* container inside navbar aligned with form container width */
.nav-inner {
  max-width: 1000px;               /* same as .container */
  width: calc(100% - 40px);        /* same horizontal margins as .container */
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

/* logo */
.nav-inner .logo img {
  height: 46px;
  display: block;
  transition: transform .18s ease;
  margin-left: 4px;
}
.nav-inner .logo img:hover { transform: scale(1.03); }

/* nav links list */
.nav-links {
  list-style: none;
  display: flex;
  gap: 14px;
  align-items: center;
  margin: 0;
  padding: 0;
}

/* primary nav link look (override any bootstrap defaults inside the navbar) */
.nav-link,
.nav-btn-outline,
.navbar .btn,
.navbar .btn-outline-primary,
.navbar a.btn {
  color: #ffffff !important;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 10px;
  transition: background .18s ease, transform .12s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.06); /* subtle translucent pill */
}

/* keep the Home button slightly more prominent (outline-style pill) */
.nav-btn-outline {
  border-radius: 999px;
  background: rgba(255,255,255,0.12);
  padding: 8px 14px;
  font-weight: 700;
}

/* Hover / active */
.nav-link:hover,
.nav-btn-outline:hover,
.navbar .btn:hover,
.navbar .btn-outline-primary:hover {
  background: rgba(255,255,255,0.18);
  transform: translateY(-2px);
}

/* If you have classes like .active from Jinja, style them here */
.nav-link.active,
.nav-links li a.active {
  background: rgba(255,255,255,0.18);
}

/* Remove any inherited Bootstrap backgrounds/green look inside navbar specifically */
.navbar .btn-outline-primary,
.navbar .btn {
  background-image: none !important;
  background-color: transparent !important;
  color: #fff !important;
  border-color: rgba(255,255,255,0.12) !important;
  box-shadow: none !important;
}

/* If some links still use .btn class with background-color, force transparent */
.navbar .btn[style],
.navbar a[style] {
  background: transparent !important;
}

/* mobile: keep layout tidy */
@media (max-width: 780px) {
  .nav-inner { width: calc(100% - 28px); gap: 8px; }
  .nav-inner .logo img { height: 40px; }
  .nav-links { gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
  .nav-btn-outline, .nav-link { padding: 6px 10px; font-size: 13px; }
}

/* ---------- Container / Card (form area) ---------- */
.container {
  background: linear-gradient(180deg, #ffffff 0%, #fbfbfd 100%);
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(14, 30, 37, 0.06);
  max-width: 1000px;
  width: calc(100% - 40px);
  margin: 92px auto 40px;
}

/* center heading inside the .container card */
.container h2 {
  text-align: center;
  width: 100%;
  margin: 0 0 18px;   /* keep spacing under the title */
  color: #007bff;
  font-weight: 700;
  line-height: 1.15;
}

/* keep the rest of your form styles (labels, grid, fields, buttons) -- paste or keep existing below */
/* ---------- Form grid: labels | fields ---------- */
.form-grid {
  display: grid;
  grid-template-columns: 220px 1fr;
  column-gap: 28px;
  row-gap: 14px;
  align-items: start;
}
.col-label {
  text-align: left;
  padding-top: 10px;
  color: #2f3b46;
  font-weight: 600;
  font-size: 14px;
}
.col-label .required::after {
  content: " *";
  color: #e11d48;
  margin-left: 4px;
  font-weight: 700;
}
.form-grid .col-field input,
.form-grid .col-field select,
.form-grid .col-field textarea,
.form-grid .col-field .btn-submit {
  box-sizing: border-box;
}
.col-field input[type="text"],
.col-field input[type="email"],
.col-field input[type="tel"],
.col-field select,
.col-field textarea {
  width: 100%;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #e6edf3;
  background: #fbfcfd;
  font-size: 14px;
  color: #111827;
  transition: box-shadow .18s, border-color .18s;
  min-height: 44px;
}
.col-field input::placeholder,
.col-field textarea::placeholder { color: #9aa4b2; }
.col-field input:focus,
.col-field select:focus,
.col-field textarea:focus {
  outline: none;
  border-color: #5b8cff;
  box-shadow: 0 6px 18px rgba(91,140,255,0.12);
}
.col-field textarea { min-height: 120px; resize: vertical; padding-top: 12px; }

/* inline rows */
.inline-row { display: flex; gap: 12px; align-items: center; }
.inline-row select { flex: 0 0 34%; min-width: 150px; height: 44px; }
.inline-row input  { flex: 1; height: 44px; }
.inline-row select, .inline-row input {
  border-radius: 8px; border: 1px solid #e6edf3; background: #fbfcfd; padding: 10px 12px;
}
.checkbox-inline, .checkbox-group {
  display: flex; gap: 16px; align-items: center; margin-top: 6px; flex-wrap: wrap;
}
.checkbox-inline label, .checkbox-group label {
  display: inline-flex; gap: 8px; align-items: center; font-weight: 500; color: #374151; cursor: pointer;
}
.checkbox-inline input[type="checkbox"], .checkbox-group input[type="checkbox"] { width: 16px; height: 16px; }
.helper { font-size:13px; color:#6b7280; margin-top:6px; }

.form-actions {
  display: flex;
  justify-content: center; /* horizontally center inside the right column */
  align-items: center;
  padding-top: 12px;
}

.btn-submit {
  display: inline-block;
  margin: 0;
  padding: 10px 26px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  background: linear-gradient(90deg, #6b8cff, #20d0c6);
  color: #fff;
  font-weight: 700;
  font-size: 15px;
  box-shadow: 0 8px 24px rgba(50,130,255,0.12);
  transition: transform .14s ease, box-shadow .14s ease;
  min-width: 160px;
}

.submit-wrap {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 16px;
}
.btn-submit:hover { display:inline-block;transform: translateY(-2px); box-shadow: 0 12px 30px rgba(50,130,255,0.14); }

/* keep flash/list styles */
ul { list-style: none; padding: 0; margin-bottom: 15px; }
li { background: #539de2; border: 1px solid #b2e6b2; color: #2d7a2d; border-radius: 6px; margin-bottom: 8px; }

.error { color: #c33; font-size: 0.85rem; display: block; margin-top: 4px; min-height: 1em; }
input:invalid { outline: 1px solid rgba(200,0,0,0.15); }
/* responsive */
@media (max-width: 880px) {
  .form-grid { grid-template-columns: 1fr; }
  .col-label { text-align: left; padding-top: 0; margin-bottom: 6px; }
  .container { padding: 22px; margin: 80px 12px 24px; }
  .inline-row { flex-direction: column; gap: 8px; }
  .inline-row select { width: 100%; min-width: auto; flex: none; }
  .inline-row input { width: 100%; }
  .btn-submit { width: 100%; min-width: 0; }
}
@media (max-width: 420px) {
  .container { padding: 18px; }
  .col-field input, .col-field select, .col-field textarea { padding: 10px; font-size: 13px; }
  .col-label { font-size: 13px; }
}
</style>



</head>
<body>
  {% if not visitor_only %}
<nav class="navbar" role="navigation" aria-label="Main navigation">
  <div class="nav-inner">
    <div class="logo">
      <a href="{{ url_for('vms') }}">
        <img src="{{ url_for('static', filename='images/Magnasoft.png') }}" alt="Company Logo">
      </a>
    </div>

    <ul class="nav-links">
      <li><a href="/" class="nav-btn-outline">Home</a></li>
      <li>
        <a href="{{ url_for('visitors_list') }}"
           class="nav-link {% if active_page=='list' %}active{% endif %}">
           Visitors List
        </a>
      </li>
      <li><a href="{{ url_for('logout') }}" class="nav-link">Logout</a></li>
    </ul>
  </div>
</nav>
{% endif %}
  <div class="container">
    <h2>Visitor Registration</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul>
          {% for category, message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form id="visitorForm" method="POST" action="{{ url_for('add_visitor') }}">
      <!-- mark this POST as coming from the public/QR visitor page -->
  <input type="hidden" name="visitor_only" value="{{ '1' if visitor_only else '' }}">

  <!-- keep these hidden so backend/email logic has the fields available even if staff selects are not shown -->
  <input type="hidden" id="contact_person" name="contact_person" value="">
  <input type="hidden" id="contact_email"  name="contact_email"  value="">
  <div class="form-grid">

    <!-- Name -->
    <div class="col-label"><label class="required">Name</label></div>
    <div class="col-field">
      <input type="text" name="name" required placeholder="Enter full name">
    </div>

    <!-- Company -->
    <div class="col-label"><label class="required">Company / Coming From</label></div>
    <div class="col-field">
      <input type="text" name="company" required placeholder="Enter company name">
    </div>

    <!-- Location -->
    <div class="col-label"><label class="required">Location</label></div>
    <div class="col-field">
      <select name="location" required>
        <option value="">Select Location</option>
        <option value="BLG">Bangalore</option>
        <option value="HYD">Hyderabad</option>
        <option value="HSN">Hassan</option>
      </select>
    </div>

    <!-- Mobile -->
    <div class="col-label"><label class="required" for="phone">Mobile</label></div>
    <div class="col-field">
        <input type="tel" id="phone" name="phone" required inputmode="tel"
          maxlength="13" pattern="^(\+91[\-\s]?)?[6-9]\d{9}$"
          placeholder="Enter mobile number" aria-describedby="phoneError"
        >
        <small id="phoneError" class="error" aria-live="polite"></small>
    </div>

<!-- ID Proof: select + number inline -->
<div class="col-label"><label for="idType">ID Proof</label></div>
<div class="col-field">
  <div class="inline-row">
    <select id="idType" name="idType" aria-describedby="idError">
      <option value="">Select ID Type</option>
      <option value="Aadhaar">Aadhaar</option>
      <option value="PAN">PAN</option>
      <option value="DrivingLicense">Driving License</option>
      <option value="Passport">Passport</option>
    </select>
    <input type="text" id="idNumber" name="idNumber" placeholder="Enter ID Number" aria-describedby="idError">
  </div>
  <small id="idError" class="error" aria-live="polite"></small>
</div>

<!-- Email -->
<div class="col-label"><label for="email">Email</label></div>
<div class="col-field">
  <input type="email" id="email" name="email" required placeholder="Enter email address" aria-describedby="emailError">
  <small id="emailError" class="error" aria-live="polite"></small>
</div>

    <!-- Purpose -->
    <div class="col-label"><label class="required">Purpose</label></div>
    <div class="col-field">
      <select id="purpose" name="purpose" required>
        <option value="">Select Purpose of Visit</option>
        <option value="Meeting">Meeting</option>
        <option value="Interview">Interview</option>
        <option value="Delivery">Delivery</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Other">Other</option>
      </select>

      <!-- Other purpose (hidden by default) -->
      <div id="otherPurposeWrap" style="display:none; margin-top:10px;">
        <input id="otherPurpose" type="text" name="otherPurpose" placeholder="Please describe other purpose">
      </div>
    </div>

    <!-- Items Carried -->
<div class="col-label"><label class="required">Items Carried</label></div>
<div class="col-field">
  <div class="checkbox-inline">
    <label><input type="checkbox" name="items" value="Laptop"> Laptop</label>
    <label><input type="checkbox" name="items" value="Pendrive"> Pendrive</label>
    <label><input type="checkbox" name="items" value="Ipad"> Ipad</label>

    <!-- 'Others' checkbox with id so we can toggle the textbox -->
    <label>
      <input id="itemsOtherCheckbox" type="checkbox" name="items" value="Other"> Others
    </label>
  </div>

  <!-- Other items text (hidden by default) -->
  <div id="itemsOtherWrap" style="display:none; margin-top:10px;">
    <input id="itemsOtherText" type="text" name="otherItems" placeholder="Describe other items">
  </div>

</div>

    <!-- Contact Person (department select above contact person select) -->
<div class="col-label"><label class="required">Contact Department</label></div>
<div class="col-field">
  <div class="inline-row">
    <!-- left: department (select) -->
    <select id="dept" name="dept" required>
      <option value="">Select Department</option>
      <option value="HR">HR</option>
      <option value="IT">IT</option>
      <option value="Admin">Admin</option>
      <option value="Support">Support</option>
      <option value="Other">Other</option>
    </select>
</div>

    <!-- Notes -->
    <div class="col-label"><label>Additional Notes</label></div>
    <div class="col-field">
      <textarea name="notes" rows="3" placeholder="Optional notes..."></textarea>
    </div>

  </div>
   <div class="submit-wrap">
    <button type="submit" class="btn-submit">Submit</button>
  </div>
</form>
  </div>
  <script>
    function fetchUsers() {
    const dept = document.getElementById('dept').value;
    const location = document.querySelector('select[name="location"]').value;
    if (!dept || !location) return;  // both must be selected

    fetch(`/get_users?dept=${encodeURIComponent(dept)}&location=${encodeURIComponent(location)}`)
        .then(res => res.json())
        .then(data => {
           const contactSelect = document.getElementById('contact_person');
          if (contactSelect) {
            contactSelect.innerHTML = '<option value="">Select Contact Person</option>';
            data.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.setAttribute('data-email', user.email);
                option.textContent = user.username;
                contactSelect.appendChild(option);
            });
            if (contactEmailEl) contactEmailEl.value = '';
          }


            const contactperson = document.getElementById('contact_person');
            if (contactperson) {
              contactperson.innerHTML = '<option value="">Select Contact Person</option>';
              data.forEach(user => {
                  const option = document.createElement('option');
                  option.value = user.username;
                  option.setAttribute('data-email', user.email);
                  option.textContent = user.username;
                  contactperson.appendChild(option);
              });
              // use the cached reference if available
              if (typeof contactEmailEl !== 'undefined' && contactEmailEl) contactEmailEl.value = '';
            }
        });
}

// Trigger when dept or location changes
document.getElementById('dept').addEventListener('change', fetchUsers);
document.querySelector('select[name="location"]').addEventListener('change', fetchUsers);


// When user selects a contact person, fill hidden email (defensive)
const contactPersonEl = document.getElementById('contact_person');
const contactEmailEl  = document.getElementById('contact_email');
if (contactPersonEl) {
  contactPersonEl.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex] || {};
    if (contactEmailEl) contactEmailEl.value = selectedOption.getAttribute('data-email') || '';
  });
}

  (function() {
    // Elements
    const purposeSelect = document.getElementById('purpose');
    const otherPurposeWrap = document.getElementById('otherPurposeWrap');
    const otherPurposeInput = document.getElementById('otherPurpose');

    const itemsOtherCheckbox = document.getElementById('itemsOtherCheckbox');
    const itemsOtherWrap = document.getElementById('itemsOtherWrap');
    const itemsOtherText = document.getElementById('itemsOtherText');

    // Show/hide helper for select (Purpose)
    function toggleOtherPurpose() {
      if (!purposeSelect) return;
      const isOther = purposeSelect.value === 'Other';
      otherPurposeWrap.style.display = isOther ? 'block' : 'none';
      if (otherPurposeInput) {
        otherPurposeInput.required = isOther;
        if (!isOther) otherPurposeInput.value = '';
      }
    }

    // Show/hide helper for items 'Others' checkbox
    function toggleItemsOther() {
      if (!itemsOtherCheckbox) return;
      const checked = itemsOtherCheckbox.checked;
      itemsOtherWrap.style.display = checked ? 'block' : 'none';
      if (itemsOtherText) {
        itemsOtherText.required = checked;
        if (!checked) itemsOtherText.value = '';
      }
    }

    // Attach listeners
    if (purposeSelect) {
      purposeSelect.addEventListener('change', toggleOtherPurpose);
      // call once on load to set correct state (handles back/forward)
      toggleOtherPurpose();
    }

    if (itemsOtherCheckbox) {
      itemsOtherCheckbox.addEventListener('change', toggleItemsOther);
      // call once on load
      toggleItemsOther();
    }

    // Optional: final validation before submit (extra safety)
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        // if purpose is Other but empty, prevent submit (browser also blocks due to required)
        if (purposeSelect && purposeSelect.value === 'Other' && otherPurposeInput && !otherPurposeInput.value.trim()) {
          otherPurposeInput.reportValidity();
          e.preventDefault();
          return;
        }
        if (itemsOtherCheckbox && itemsOtherCheckbox.checked && itemsOtherText && !itemsOtherText.value.trim()) {
          itemsOtherText.reportValidity();
          e.preventDefault();
          return;
        }
      });
    }
  })();


document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('visitorForm');
  if (!form) return; // nothing to do if form id missing
  const phone = document.getElementById('phone');
  const idType = document.getElementById('idType');
  const idNumber = document.getElementById('idNumber');
  const email = document.getElementById('email');
  const phoneError = document.getElementById('phoneError');
  const idError = document.getElementById('idError');
  const emailError = document.getElementById('emailError');
  const ID_PATTERNS = {
    Aadhaar: { pattern: '^\\d{12}$', placeholder: '12 digits (e.g. 123412341234)', title: '12 digit Aadhaar number' },
    PAN: { pattern: '^[A-Z]{5}[0-9]{4}[A-Z]{1}$', placeholder: 'PAN (e.g. ABCDE1234F)', title: 'PAN: 5 letters, 4 digits, 1 letter' },
    DrivingLicense: { pattern: '^[A-Za-z0-9\\-\\/\\s]{6,16}$', placeholder: 'Driving license (6-16 chars)', title: 'Driving license number (6â€“16 chars)' },
    Passport: { pattern: '^[A-PR-WY][0-9]{7}$', placeholder: 'Passport (e.g. A1234567)', title: 'Passport: 1 letter + 7 digits' }
  };
  function showError(el, msg) {
    if (!el) return;
    el.textContent = msg || '';
  }
  function updateIdValidation() {
    const val = idType.value;
    if (ID_PATTERNS[val]) {
      idNumber.setAttribute('pattern', ID_PATTERNS[val].pattern);
      idNumber.setAttribute('title', ID_PATTERNS[val].title);
      idNumber.placeholder = ID_PATTERNS[val].placeholder;
      idNumber.required = true;
    } else {
      idNumber.removeAttribute('pattern');
      idNumber.removeAttribute('title');
      idNumber.placeholder = 'Enter ID Number';
      idNumber.required = false;
      showError(idError, '');
    }
    idNumber.value = idNumber.value.trim();
    idNumber.setCustomValidity('');
  }
  phone.addEventListener('input', () => {
    const ok = phone.checkValidity();
    if (!ok) {
      showError(phoneError, 'Enter valid mobile number (10 digits, start 6-9). Optional +91 prefix allowed.');
    } else {
      showError(phoneError, '');
    }
    phone.setCustomValidity(ok ? '' : 'invalid');
  });
  email.addEventListener('input', () => {
    const ok = email.checkValidity();
    showError(emailError, ok ? '' : 'Enter a valid email address.');
    email.setCustomValidity(ok ? '' : 'invalid');
  });
  idType.addEventListener('change', updateIdValidation);
  idNumber.addEventListener('input', () => {
    if (idNumber.hasAttribute('pattern')) {
      const ok = idNumber.checkValidity();
      showError(idError, ok ? '' : 'ID number does not match expected format for selected ID type.');
      idNumber.setCustomValidity(ok ? '' : 'invalid');
    } else {
      showError(idError, '');
      idNumber.setCustomValidity('');
    }
  });
  form.addEventListener('submit', (ev) => {
    updateIdValidation();
    if (!form.checkValidity()) {
      ev.preventDefault();
      if (!phone.checkValidity()) showError(phoneError, 'Enter valid mobile number (10 digits, start 6-9).');
      if (!email.checkValidity()) showError(emailError, 'Enter a valid email address.');
      if (idNumber.required && !idNumber.checkValidity()) showError(idError, 'ID number invalid for selected ID type.');
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) firstInvalid.focus();
      return false;
    }
  });
  updateIdValidation();
});
</script>

</body>
</html>